{% extends "base.html" %}
{% block title %}AutoCreator ‚Äî Topic{% endblock %}
{% block content %}
<main>
  {% if error %}
  <article style="background:#ffecec;border:1px solid #ffb3b3;padding:.75rem;border-radius:8px">
    <strong>Error:</strong> {{ error }}
  </article>
  {% endif %}

  <form method="post" action="/topic/generate">
    <h3>Create a topic post</h3>
    <div class="grid">
      <input name="topic" placeholder="Topic (e.g., How NASA uses AI on Mars)" value="{{ topic or '' }}" required>
      <input name="angle" placeholder="Angle (optional)" value="{{ angle or '' }}">
      <select name="platform">
        <option value="linkedin" {% if platform=='linkedin' %}selected{% endif %}>LinkedIn</option>
        <option value="bluesky" {% if platform=='bluesky' %}selected{% endif %}>Bluesky</option>
      </select>
      <select name="length">
        <option value="short"  {% if length=='short' %}selected{% endif %}>Short</option>
        <option value="medium" {% if length!='short' and length!='long' %}selected{% endif %}>Medium</option>
        <option value="long"   {% if length=='long' %}selected{% endif %}>Long</option>
      </select>
    </div>
    <label><input type="checkbox" name="use_research" value="1" {% if use_research=='1' %}checked{% endif %}> Use research pack (web sources)</label>
    <label><input type="checkbox" name="include_sources" value="1" {% if include_sources!='0' %}checked{% endif %}> Include ‚ÄúSources‚Äù line in final post</label>
    <button type="submit">Generate 3 Variants</button>
  </form>

  {% if sources_used and sources_used|length>0 %}
  <article>
    <strong>Sources used for drafting:</strong>
    <ul>
      {% for s in sources_used %}
        <li><a href="{{ s.url }}" target="_blank">{{ s.title }}</a></li>
      {% endfor %}
    </ul>
  </article>
  {% endif %}

  {% if variants %}
  <hr>
  <h4>Variants</h4>
  {% for v in variants %}
    <article>
      <header><strong>Variant {{ v.variant }}</strong></header>
      <p style="white-space:pre-wrap">{{ v.text }}</p>
      <details><summary>Rationale</summary><p>{{ v.rationale }}</p></details>

      <form method="post" action="/topic/finalize" style="margin-top:.5rem">
        <input type="hidden" name="platform" value="{{ platform }}">
        <input type="hidden" name="include_sources" value="{{ include_sources or '1' }}">
        <input type="hidden" name="sources_domains" value="{{ sources_domains or '' }}">
        <textarea name="text">{{ v.text }}</textarea>
        <button type="submit">Finalize for {{ platform|capitalize }}</button>
      </form>

      <form method="post" action="/topic/factcheck" style="margin-top:.25rem">
        <input type="hidden" name="platform" value="{{ platform }}">
        <input type="hidden" name="topic" value="{{ topic or '' }}">
        <input type="hidden" name="angle" value="{{ angle or '' }}">
        <input type="hidden" name="length" value="{{ length or 'medium' }}">
        <input type="hidden" name="use_research" value="{{ use_research or '0' }}">
        <input type="hidden" name="include_sources" value="{{ include_sources or '1' }}">
        <input type="hidden" name="sources_domains" value="{{ sources_domains or '' }}">
        <textarea name="text" style="display:none">{{ v.text }}</textarea>
        <button type="submit" class="secondary">Fact-check this draft</button>
      </form>
    </article>
  {% endfor %}
  {% endif %}

  {% if final_text %}
  <hr>
  <h4>Finalized</h4>
  <textarea id="finalText">{{ final_text }}</textarea>

  {% set can_publish = True %}
  {% if audits %}
    {% for a in audits %}
      {% if a.confidence < 0.7 %}
        {% set can_publish = False %}
      {% endif %}
    {% endfor %}
  {% endif %}

  <div class="grid">
    {% if can_publish %}
      <form method="post" action="/topic/publish/bluesky">
        <input type="hidden" name="text" value="{{ final_text }}">
        <button type="submit">Publish to Bluesky</button>
      </form>
    {% else %}
      <button disabled title="Fix low-confidence claims before publishing">Publish to Bluesky (blocked)</button>
    {% endif %}
    <button type="button" onclick="copyText('finalText')">Copy for LinkedIn</button>
  </div>

  <form method="post" action="/topic/factcheck" style="margin-top:.5rem">
    <input type="hidden" name="platform" value="{{ platform }}">
    <input type="hidden" name="topic" value="{{ topic or '' }}">
    <input type="hidden" name="angle" value="{{ angle or '' }}">
    <input type="hidden" name="length" value="{{ length or 'medium' }}">
    <input type="hidden" name="use_research" value="{{ use_research or '0' }}">
    <input type="hidden" name="include_sources" value="{{ include_sources or '1' }}">
    <input type="hidden" name="sources_domains" value="{{ sources_domains or '' }}">
    <textarea name="text" style="display:none">{{ final_text }}</textarea>
    <button type="submit" class="secondary">Fact-check finalized text</button>
  </form>
  {% endif %}

  {% if fact_checked %}
  <hr>
  <h4>Fact-check</h4>
  {% if audits and audits|length>0 %}
    <p>Found <strong>{{ audit_count }}</strong> factual {{ 'claim' if audit_count==1 else 'claims' }}.</p>
    <ol>
    {% for a in audits %}
      {% set cls = 'badge-ok' if a.confidence >= 0.85 else ('badge-warn' if a.confidence >= 0.7 else 'badge-err') %}
      <li style="margin-bottom:1rem">
        <strong>{{ a.claim }}</strong>
        <span class="badge {{ cls }}" title="Confidence">{{ a.confidence }}</span>
        <div style="margin-top:.5rem">
          {% for s in a.sources %}
            <div style="margin-left:.75rem">
              <a href="{{ s.url }}" target="_blank">{{ s.title }}</a>
              <div class="muted">{{ s.snippet }}</div>
            </div>
          {% endfor %}
        </div>
      </li>
    {% endfor %}
    </ol>
    <p class="muted"><small>Legend: <span class="badge badge-ok">‚â•0.85</span> strong ‚Ä¢ <span class="badge badge-warn">0.70‚Äì0.84</span> medium ‚Ä¢ <span class="badge badge-err">&lt;0.70</span> weak</small></p>
  {% else %}
    <p>üîç Fact-check ran, but <strong>no factual claims</strong> were detected. Add a date/number/name if you want verification.</p>
  {% endif %}
  {% endif %}

  {% if publish %}
  <p>
    {% if publish.ok %}
      ‚úÖ Published! {% if publish.permalink %}<a href="{{ publish.permalink }}" target="_blank">View post</a>{% endif %}
    {% else %}
      ‚ùå {{ publish.message }}
    {% endif %}
  </p>
  {% endif %}
</main>
{% endblock %}
